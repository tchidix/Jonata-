<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EliteSmart - Painel Principal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #00c9ff;
            --secondary: #92fe9d;
            --dark: #0f2027;
            --dark-light: #203a43;
            --darker: #2c5364;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark), var(--dark-light), var(--darker));
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Navbar */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 32, 39, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            z-index: 1000;
            border-top: 1px solid rgba(0, 201, 255, 0.2);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }
        
        .nav-item.active, .nav-item:hover {
            color: var(--primary);
            transform: translateY(-5px);
        }
        
        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .nav-item span {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -15px;
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: linear-gradient(180deg, var(--dark), var(--dark-light));
            z-index: 2000;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            padding-top: 70px;
        }
        
        .side-menu.open {
            left: 0;
        }
        
        .menu-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .menu-header h3 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .menu-header p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .menu-item {
            padding: 18px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background: rgba(0, 201, 255, 0.1);
            color: var(--primary);
            padding-left: 30px;
        }
        
        .menu-item i {
            font-size: 1.2rem;
            margin-right: 15px;
            width: 24px;
            text-align: center;
        }
        
        .menu-item span {
            font-weight: 500;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary);
            transform: translateX(-100%);
            transition: transform 0.3s;
        }
        
        .menu-item:hover::before {
            transform: translateX(0);
        }
        
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            animation: fadeIn 0.3s;
        }
        
        /* Main Content */
        .main-content {
            padding: 20px 20px 80px 20px;
            animation: fadeIn 0.5s;
        }
        
        .greeting {
            margin-bottom: 25px;
            animation: fadeIn 0.8s;
        }
        
        .greeting h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .greeting p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }
        
        .greeting .user-id {
            display: inline-block;
            background: rgba(0, 201, 255, 0.1);
            padding: 5px 15px;
            border-radius: 50px;
            font-family: monospace;
            letter-spacing: 1px;
            border: 1px solid rgba(0, 201, 255, 0.3);
            margin-top: 10px;
            animation: pulse 3s infinite;
        }
        
        /* Chart Container - FIXED SIZE */
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 1.2s;
            height: 250px;
            position: relative;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-header h3 {
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Earnings Dashboard */
        .earnings-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .earning-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .earning-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(0, 201, 255, 0.1);
        }
        
        .earning-card i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .earning-card .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .earning-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        /* Messages */
        .messages {
            margin-bottom: 25px;
            animation: fadeIn 1.4s;
        }
        
        .message-card {
            background: linear-gradient(90deg, rgba(0, 201, 255, 0.1), rgba(146, 254, 157, 0.1));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary);
            animation: slideInRight 0.5s;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .message-card:nth-child(2) {
            border-left-color: var(--secondary);
            animation-delay: 0.2s;
        }
        
        .message-card:nth-child(3) {
            border-left-color: #ffd700;
            animation-delay: 0.4s;
        }
        
        .message-card i {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .message-card p {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--dark), var(--dark-light));
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: scaleUp 0.5s;
            border: 1px solid rgba(0, 201, 255, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h3 {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            color: var(--primary);
            transform: rotate(90deg);
        }
        
        .modal-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: var(--dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 1.1rem;
        }
        
        .modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 201, 255, 0.3);
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animation for balance update */
        @keyframes balanceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: var(--secondary); }
            100% { transform: scale(1); }
        }
        
        .updated {
            animation: balanceUpdate 0.5s;
        }
        
        /* Notification Styles - Substitui alerts */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--dark);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.5s;
            max-width: 300px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.error {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            color: var(--dark);
        }
        
        .notification.success {
            background: linear-gradient(90deg, #92fe9d, #00c9ff);
            color: var(--dark);
        }
        
        /* Modal Error/Warning Messages */
        .modal-message {
            background: rgba(255,107,107,0.1);
            border-left: 4px solid #ff6b6b;
            padding: 12px;
            margin-bottom: 15px;
            margin-top: 10px;
            border-radius: 4px;
            animation: fadeIn 0.5s;
        }
        
        .modal-message.success {
            background: rgba(146, 254, 157, 0.1);
            border-left-color: #92fe9d;
        }
        
        .modal-message.warning {
            background: rgba(255, 215, 0, 0.1);
            border-left-color: #ffd700;
        }
        
        .modal-message p {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-message.success p {
            color: #92fe9d;
        }
        
        .modal-message.warning p {
            color: #ffd700;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .navbar {
                top: 0;
                bottom: auto;
                justify-content: flex-start;
                padding-left: 20px;
                gap: 40px;
            }
            
            .main-content {
                padding: 100px 40px 40px;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .earnings-dashboard {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .messages {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .message-card {
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 480px) {
            .message-card {
                margin-bottom: 15px;
            }
            
            .earnings-dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <h3>EliteSmart</h3>
            <p>Menu Principal</p>
        </div>
        
        <div class="menu-item" data-page="balance">
            <i class="fas fa-wallet"></i>
            <span>Ver Saldos</span>
        </div>
        
        <div class="menu-item" data-page="card">
            <i class="fas fa-credit-card"></i>
            <span>Cart√£o Banc√°rio</span>
        </div>
        
        <div class="menu-item" data-page="profile">
            <i class="fas fa-user-circle"></i>
            <span>Os Meus Dados</span>
        </div>
        
        <div class="menu-item" data-page="earnings">
            <i class="fas fa-chart-line"></i>
            <span>Rendimentos</span>
        </div>
        
        <div class="menu-item" data-page="withdraw">
            <i class="fas fa-money-bill-wave"></i>
            <span>Levantamento</span>
        </div>
        
        <a href="investir.html" class="menu-item">
            <i class="fas fa-seedling"></i>
            <span>Investir</span>
        </a>
        
        <div class="menu-item" data-page="team">
            <i class="fas fa-users"></i>
            <span>Equipe</span>
        </div>
        
        <div class="menu-item" data-page="graph">
            <i class="fas fa-chart-bar"></i>
            <span>Gr√°fico em Tempo Real</span>
        </div>
        
        <div class="menu-item" data-page="goals">
            <i class="fas fa-bullseye"></i>
            <span>Minhas Metas</span>
        </div>
        
        <a href="depositar.html" class="menu-item">
            <i class="fas fa-download"></i>
            <span>Depositar</span>
        </a>
        
        <div class="menu-item" data-page="lottery">
            <i class="fas fa-dice"></i>
            <span>Lotaria</span>
        </div>
        
        <div class="menu-item" data-page="support">
            <i class="fas fa-headset"></i>
            <span>Suporte</span>
        </div>
        
        <div class="menu-item" data-page="history">
            <i class="fas fa-history"></i>
            <span>Hist√≥rico</span>
        </div>
        
        <div class="menu-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Sair</span>
        </div>
    </div>
    
    <div class="menu-overlay" id="menuOverlay"></div>
    
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-item active" data-page="home">
            <i class="fas fa-home"></i>
            <span>In√≠cio</span>
        </div>
        
        <div class="nav-item" data-page="tasks">
            <i class="fas fa-tasks"></i>
            <span>Tarefas</span>
        </div>
        
        <div class="nav-item" id="menuBtn">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="loading" id="loadingScreen">
            <div class="spinner"></div>
            <p>Carregando dados...</p>
        </div>
        
        <div id="dashboardContent" style="display: none;">
            <!-- Greeting -->
            <div class="greeting">
                <h1 id="userGreeting">Ol√°, Investidor!</h1>
                <p>Bem-vindo de volta ao seu painel de investimentos</p>
                <div class="user-id" id="userIdDisplay">ID: EL783F9A</div>
            </div>
            
            <!-- Chart - Quadro de Rendimentos -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i> Quadro de Rendimentos (7 Dias)</h3>
                </div>
                <canvas id="earningsChart" height="180"></canvas>
            </div>
            
            <!-- Earnings Dashboard -->
            <div class="earnings-dashboard">
                <div class="earning-card">
                    <i class="fas fa-coins"></i>
                    <div class="label">Rendimento Di√°rio</div>
                    <div class="value" id="dailyEarnings">0 Kz</div>
                </div>
                
                <div class="earning-card">
                    <i class="fas fa-seedling"></i>
                    <div class="label">Investimento Ativo</div>
                    <div class="value" id="activeInvestment">0 Kz</div>
                </div>
                
                <div class="earning-card">
                    <i class="fas fa-percentage"></i>
                    <div class="label">Retorno Di√°rio</div>
                    <div class="value" id="dailyReturn">0%</div>
                </div>
                
                <div class="earning-card">
                    <i class="fas fa-calendar-alt"></i>
                    <div class="label">Esta Semana</div>
                    <div class="value" id="weeklyEarnings">0 Kz</div>
                </div>
            </div>
            
            <!-- Messages -->
            <div class="messages">
                <div class="message-card">
                    <i class="fas fa-tasks"></i>
                    <p>Complete suas tarefas di√°rias e ganhe b√¥nus proporcional ao seu investimento!</p>
                </div>
                
                <div class="message-card">
                    <i class="fas fa-seedling"></i>
                    <p>Invista agora e aumente seus rendimentos di√°rios automaticamente.</p>
                </div>
                
                <div class="message-card">
                    <i class="fas fa-user-plus"></i>
                    <p>Convide amigos e ganhe 15% de comiss√£o sobre o primeiro investimento deles.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC8OBZQm2dbUGeyuCTHCRgEwKhplCarxco",
            authDomain: "luno-money.firebaseapp.com",
            projectId: "luno-money",
            storageBucket: "luno-money.firebasestorage.app",
            messagingSenderId: "307225462580",
            appId: "1:307225462580:web:5068a443fc54ee4b448761"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let userData = null;
        let userDocRef = null;
        let earningsChart = null;
        let unsubscribeUser = null;
        let unsubscribeLottery = null;
        let realTimeChart = null;
        
        // Investment return rates based on plan
        const investmentReturnRates = {
            1: 0.06,  // 6% daily for Plano Inicial (1000 ‚Üí 60)
            2: 0.06,  // 6% daily for Plano Bronze (2500 ‚Üí 150)
            3: 0.044, // 4.44% daily for Plano Prata (4500 ‚Üí 200)
            4: 0.0625, // 6.25% daily for Plano Ouro (8000 ‚Üí 500)
            5: 0.06,  // 6% daily for Plano Platina (15000 ‚Üí 900)
            6: 0.06,  // 6% daily for Plano Diamante (30000 ‚Üí 1800)
            7: 0.06,  // 6% daily for Plano VIP (50000 ‚Üí 3000)
            8: 0.06,  // 6% daily for Plano Premium (75000 ‚Üí 4500)
            9: 0.06,  // 6% daily for Plano Elite (100000 ‚Üí 6000)
            10: 0.06  // 6% daily for Plano Master (150000 ‚Üí 9000)
        };
        
        // Lottery prizes based on bet amount (MULTIPLICADORES) - CORRIGIDO
        const lotteryPrizeMultipliers = {
            1: 0.5,    // 1 acerto: devolve 50% do valor apostado
            2: 2.5,    // 2 acertos: 2.5x o valor apostado
            3: 10,     // 3 acertos: 10x o valor apostado
            4: 50,     // 4 acertos: 50x o valor apostado
            5: 500     // 5 acertos: 500x o valor apostado
        };
        
        // DOM Elements
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuBtn = document.getElementById('menuBtn');
        const mainContent = document.getElementById('mainContent');
        const dashboardContent = document.getElementById('dashboardContent');
        const loadingScreen = document.getElementById('loadingScreen');
        const modalContainer = document.getElementById('modalContainer');
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await initializeUserData();
                    setupRealTimeListeners();
                } else {
                    // Redirect to signup if not logged in
                    window.location.href = 'signup.html';
                }
            });
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Initialize user data
        async function initializeUserData() {
            try {
                userDocRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userDocRef.get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    updateDashboard();
                    initChart();
                    
                    // Update last login
                    await userDocRef.update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Check for automatic lottery draws
                    await checkAutomaticLotteryDraws();
                    
                    // Check referrals for commission
                    await checkReferrals();
                    
                    // Verificar se h√° apostas de lotaria pendentes
                    await checkPendingLotteryBets();
                } else {
                    // User document doesn't exist (should not happen)
                    console.error('User document not found');
                    await auth.signOut();
                    window.location.href = 'signup.html';
                }
            } catch (error) {
                console.error('Error initializing user data:', error);
                loadingScreen.innerHTML = '<p>Erro ao carregar dados. Tente novamente.</p>';
            }
        }
        
        // Check for pending lottery bets that might not have been processed
        async function checkPendingLotteryBets() {
            try {
                // Get user's pending lottery bets
                const pendingBets = await db.collection('users').doc(currentUser.uid)
                    .collection('lottery')
                    .where('status', '==', 'pending')
                    .get();
                
                if (pendingBets.empty) {
                    return;
                }
                
                console.log(`Verificando ${pendingBets.size} apostas pendentes do usu√°rio`);
                
                // Check if there are any completed draws
                const latestDraw = await db.collection('lottery_draws')
                    .where('status', '==', 'completed')
                    .orderBy('processedAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!latestDraw.empty) {
                    const drawData = latestDraw.docs[0].data();
                    const drawId = latestDraw.docs[0].id;
                    
                    // Check if this draw has already been processed for this user
                    const lastProcessedDraw = localStorage.getItem('lastProcessedDraw');
                    if (lastProcessedDraw !== drawId) {
                        console.log('Processando apostas pendentes com sorteio existente');
                        await processUserLotteryBets(drawData, drawId);
                        localStorage.setItem('lastProcessedDraw', drawId);
                    }
                }
            } catch (error) {
                console.error('Error checking pending lottery bets:', error);
            }
        }
        
        // Setup real-time listeners
        function setupRealTimeListeners() {
            // User data listener - EM TEMPO REAL
            unsubscribeUser = userDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const newData = doc.data();
                    
                    // Check for changes
                    if (JSON.stringify(userData) !== JSON.stringify(newData)) {
                        userData = newData;
                        updateDashboard();
                        updateChart();
                        
                        // Show notification if balance increased
                        const oldBalance = userData.balance || 0;
                        const newBalance = newData.balance || 0;
                        if (newBalance > oldBalance) {
                            const diff = newBalance - oldBalance;
                            if (diff > 0) {
                                showNotification(`üí∞ Novo rendimento: +${diff.toLocaleString()} Kz`);
                            }
                        }
                    }
                }
            }, (error) => {
                console.error('Error in real-time listener:', error);
            });
            
            // Lottery draws listener - EM TEMPO REAL
            unsubscribeLottery = db.collection('lottery_draws')
                .where('status', '==', 'completed')
                .orderBy('processedAt', 'desc')
                .limit(1)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const drawData = change.doc.data();
                            const drawId = change.doc.id;
                            
                            // Check if this draw has already been processed for this user
                            const lastProcessedDraw = localStorage.getItem('lastProcessedDraw');
                            if (lastProcessedDraw !== drawId) {
                                console.log('Novo sorteio detectado em tempo real:', drawId);
                                await processUserLotteryBets(drawData, drawId);
                                localStorage.setItem('lastProcessedDraw', drawId);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Error in lottery listener:', error);
                });
        }
        
        // Check for automatic lottery draws
        async function checkAutomaticLotteryDraws() {
            try {
                // Check for recent completed draws
                const draws = await db.collection('lottery_draws')
                    .where('status', '==', 'completed')
                    .orderBy('processedAt', 'desc')
                    .limit(1)
                    .get();
                
                if (!draws.empty) {
                    const latestDraw = draws.docs[0];
                    const drawData = latestDraw.data();
                    const drawId = latestDraw.id;
                    
                    // Check if this draw has already been processed for this user
                    const lastProcessedDraw = localStorage.getItem('lastProcessedDraw');
                    if (lastProcessedDraw !== drawId) {
                        await processUserLotteryBets(drawData, drawId);
                        localStorage.setItem('lastProcessedDraw', drawId);
                    }
                }
            } catch (error) {
                console.error('Error checking lottery draws:', error);
            }
        }
        
        // Process user's lottery bets for a draw - FUN√á√ÉO PRINCIPAL CORRIGIDA
        async function processUserLotteryBets(drawData, drawId) {
            try {
                const drawnNumbers = drawData.numbers || [];
                
                if (!drawnNumbers || drawnNumbers.length === 0) {
                    console.error('N√∫meros sorteados n√£o dispon√≠veis no sorteio:', drawId);
                    return;
                }
                
                // Get user's pending lottery bets
                const pendingBets = await db.collection('users').doc(currentUser.uid)
                    .collection('lottery')
                    .where('status', '==', 'pending')
                    .get();
                
                if (pendingBets.empty) {
                    return;
                }
                
                console.log(`Processando ${pendingBets.size} apostas pendentes para o usu√°rio`);
                console.log('N√∫meros sorteados:', drawnNumbers);
                
                let totalPrize = 0;
                let processedBets = 0;
                
                // Process each pending bet
                for (const betDoc of pendingBets.docs) {
                    const bet = betDoc.data();
                    const betNumbers = bet.numbers || [];
                    const betAmount = bet.amount || 0;
                    
                    if (betNumbers.length === 0) {
                        console.log('Aposta sem n√∫meros, ignorando:', betDoc.id);
                        continue;
                    }
                    
                    // Calculate hits
                    const hits = betNumbers.filter(num => drawnNumbers.includes(num)).length;
                    
                    // Calculate prize based on hits (multiplicador do valor apostado)
                    let prize = 0;
                    if (hits >= 1 && hits <= 5) {
                        prize = betAmount * lotteryPrizeMultipliers[hits];
                        console.log(`Aposta ${betDoc.id}: ${hits} acertos, aposta: ${betAmount} Kz, multiplicador: ${lotteryPrizeMultipliers[hits]}x, pr√™mio: ${prize} Kz`);
                    } else {
                        console.log(`Aposta ${betDoc.id}: ${hits} acertos, sem pr√™mio`);
                    }
                    
                    // Update lottery bet
                    await betDoc.ref.update({
                        status: 'completed',
                        drawnNumbers: drawnNumbers,
                        hits: hits,
                        prize: prize,
                        processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        drawId: drawId
                    });
                    
                    processedBets++;
                    
                    // If prize > 0, add to user balance
                    if (prize > 0) {
                        // CORRE√á√ÉO PRINCIPAL: Garantir que o saldo seja atualizado
                        try {
                            // Get current user data
                            const userDoc = await db.collection('users').doc(currentUser.uid).get();
                            const currentUserData = userDoc.data();
                            const currentBalance = currentUserData.balance || 0;
                            const currentEarnings = currentUserData.earnings || 0;
                            
                            // Update user balance and earnings - CORRE√á√ÉO CR√çTICA
                            await db.collection('users').doc(currentUser.uid).update({
                                balance: firebase.firestore.FieldValue.increment(prize),
                                earnings: firebase.firestore.FieldValue.increment(prize)
                            });
                            
                            // Record transaction
                            await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                                type: 'lottery_win',
                                amount: prize,
                                description: `Pr√™mio da lotaria (${hits} acertos) - Valor apostado: ${betAmount.toLocaleString()} Kz - N√∫meros sorteados: ${drawnNumbers.join(', ')}`,
                                status: 'completed',
                                balanceAfter: currentBalance + prize,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                drawId: drawId
                            });
                            
                            // Atualizar dados locais imediatamente
                            userData.balance = currentBalance + prize;
                            userData.earnings = currentEarnings + prize;
                            
                            totalPrize += prize;
                            
                            console.log(`Pr√™mio adicionado: ${prize} Kz para usu√°rio ${currentUser.uid}`);
                            
                        } catch (userError) {
                            console.error('Erro ao adicionar pr√™mio ao saldo:', userError);
                        }
                    }
                }
                
                console.log(`Total de apostas processadas: ${processedBets}`);
                console.log(`Total de pr√™mios recebidos: ${totalPrize} Kz`);
                
                if (totalPrize > 0) {
                    // Atualizar dashboard em tempo real
                    updateDashboard();
                    
                    // Show notification to user
                    showNotification(`üéä Voc√™ recebeu ${totalPrize.toLocaleString()} Kz de pr√™mio da lotaria!`, 'success');
                } else if (processedBets > 0) {
                    showNotification('üéØ Seu resultado da lotaria est√° dispon√≠vel no hist√≥rico!', 'warning');
                }
                
            } catch (error) {
                console.error('Error processing lottery bets:', error);
                showNotification('‚ùå Erro ao processar apostas da lotaria. Contate o suporte.', 'error');
            }
        }
        
        // Check referrals and calculate commissions (APENAS 15% DO PRIMEIRO INVESTIMENTO)
        async function checkReferrals() {
            try {
                // Buscar usu√°rios que foram indicados por este usu√°rio
                const referralsSnapshot = await db.collection('users')
                    .where('referredBy', '==', userData.userId)
                    .get();
                
                if (!referralsSnapshot.empty) {
                    for (const referralDoc of referralsSnapshot.docs) {
                        const referralData = referralDoc.data();
                        const referralId = referralDoc.id;
                        
                        // Verificar se este referral j√° teve sua comiss√£o processada
                        if (!referralData.commissionPaid) {
                            // Verificar se o referral tem investimentos
                            const referralInvestments = referralData.activeInvestments || [];
                            if (referralInvestments.length > 0) {
                                // Calcular 15% do primeiro investimento
                                let totalFirstInvestment = 0;
                                
                                // Encontrar o primeiro investimento
                                const firstInvestment = referralInvestments[0];
                                if (firstInvestment) {
                                    totalFirstInvestment = firstInvestment.amount || 0;
                                    
                                    // Calcular comiss√£o (15%)
                                    const commission = totalFirstInvestment * 0.15;
                                    
                                    if (commission > 0) {
                                        // Adicionar comiss√£o ao usu√°rio atual
                                        await db.collection('users').doc(currentUser.uid).update({
                                            balance: firebase.firestore.FieldValue.increment(commission),
                                            earnings: firebase.firestore.FieldValue.increment(commission),
                                            referralEarnings: firebase.firestore.FieldValue.increment(commission)
                                        });
                                        
                                        // Registrar transa√ß√£o
                                        await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                                            type: 'referral_commission',
                                            amount: commission,
                                            description: `Comiss√£o de indica√ß√£o: 15% do investimento de ${referralData.fullName || 'Novo Usu√°rio'} (${totalFirstInvestment.toLocaleString()} Kz)`,
                                            status: 'completed',
                                            balanceAfter: (userData.balance || 0) + commission,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            referralId: referralId
                                        });
                                        
                                        // Marcar que a comiss√£o foi paga
                                        await db.collection('users').doc(referralId).update({
                                            commissionPaid: true
                                        });
                                        
                                        // Atualizar dados locais
                                        userData.balance = (userData.balance || 0) + commission;
                                        userData.earnings = (userData.earnings || 0) + commission;
                                        userData.referralEarnings = (userData.referralEarnings || 0) + commission;
                                        
                                        // Mostrar notifica√ß√£o
                                        showNotification(`üéâ Comiss√£o de indica√ß√£o: +${commission.toLocaleString()} Kz`, 'success');
                                        
                                        console.log(`Comiss√£o de ${commission} Kz paga para o usu√°rio ${currentUser.uid} do referral ${referralId}`);
                                        
                                        // Atualizar dashboard em tempo real
                                        updateDashboard();
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking referrals:', error);
            }
        }
        
        // Show notification - Substitui alerts
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: var(--dark);
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: slideInRight 0.5s;
                max-width: 300px;
                font-weight: bold;
            `;
            
            let icon = 'fa-gift';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${icon}" style="font-size: 1.2rem;"></i>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        }
        
        // Show modal message - Para uso dentro de modais
        function showModalMessage(modal, message, type = 'error') {
            // Remove existing messages
            const existingMessages = modal.querySelectorAll('.modal-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `modal-message ${type}`;
            messageDiv.innerHTML = `
                <p>
                    <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
                    ${message}
                </p>
            `;
            
            // Insert after the modal header or at the top of modal content
            const modalContent = modal.querySelector('.modal-content');
            const modalHeader = modal.querySelector('.modal-header');
            if (modalHeader) {
                modalHeader.parentNode.insertBefore(messageDiv, modalHeader.nextSibling);
            } else {
                modalContent.insertBefore(messageDiv, modalContent.firstChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 500);
                }
            }, 5000);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Toggle side menu
            menuBtn.addEventListener('click', function() {
                sideMenu.classList.add('open');
                menuOverlay.style.display = 'block';
            });
            
            // Close side menu
            menuOverlay.addEventListener('click', function() {
                sideMenu.classList.remove('open');
                menuOverlay.style.display = 'none';
            });
            
            // Menu item clicks
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Se for um link (<a>), n√£o previna o comportamento padr√£o
                    if (this.tagName === 'A' && (this.getAttribute('href') === 'investir.html' || this.getAttribute('href') === 'depositar.html')) {
                        return; // Deixa o link funcionar normalmente
                    }
                    
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    
                    // Close menu
                    sideMenu.classList.remove('open');
                    menuOverlay.style.display = 'none';
                    
                    // Show modal for selected page
                    if (page) {
                        showPageModal(page);
                    }
                });
            });
            
            // Nav item clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    
                    // Remove active class from all nav items
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Show page
                    if (page === 'home') {
                        // Already on home
                    } else if (page === 'tasks') {
                        showTasksModal();
                    }
                });
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                try {
                    if (unsubscribeUser) unsubscribeUser();
                    if (unsubscribeLottery) unsubscribeLottery();
                    await auth.signOut();
                    window.location.href = 'signup.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            });
        }
        
        // Calculate daily earnings based on investments
        function calculateDailyEarnings() {
            if (!userData.activeInvestments || userData.activeInvestments.length === 0) {
                return {
                    total: 0,
                    fromInvestment: 0,
                    task1: 0,
                    task2: 0,
                    activeInvestmentAmount: 0,
                    dailyReturnRate: 0,
                    weekly: 0
                };
            }
            
            let totalInvestment = 0;
            let totalDailyEarnings = 0;
            
            userData.activeInvestments.forEach(investment => {
                const planId = investment.planId || 1;
                const investmentAmount = investment.amount || 0;
                const dailyRate = investmentReturnRates[planId] || 0.06;
                
                totalInvestment += investmentAmount;
                totalDailyEarnings += investmentAmount * dailyRate;
            });
            
            // Each task gives 50% of daily earnings
            const taskEarning = totalDailyEarnings / 2;
            const dailyReturnRate = totalInvestment > 0 ? (totalDailyEarnings / totalInvestment) * 100 : 0;
            const weeklyEarnings = totalDailyEarnings * 7;
            
            return {
                total: totalDailyEarnings,
                fromInvestment: totalDailyEarnings,
                task1: taskEarning,
                task2: taskEarning,
                activeInvestmentAmount: totalInvestment,
                dailyReturnRate: dailyReturnRate.toFixed(2),
                weekly: weeklyEarnings
            };
        }
        
        // Update dashboard with user data - EM TEMPO REAL
        function updateDashboard() {
            document.getElementById('userGreeting').textContent = `Ol√°, ${userData.fullName}!`;
            document.getElementById('userIdDisplay').textContent = `ID: ${userData.userId}`;
            
            // Calculate and update daily earnings
            const dailyEarnings = calculateDailyEarnings();
            
            // Animate value changes
            animateValueChange('dailyEarnings', Math.round(dailyEarnings.total).toLocaleString() + ' Kz');
            animateValueChange('activeInvestment', Math.round(dailyEarnings.activeInvestmentAmount).toLocaleString() + ' Kz');
            animateValueChange('dailyReturn', dailyEarnings.dailyReturnRate + '%');
            animateValueChange('weeklyEarnings', Math.round(dailyEarnings.weekly).toLocaleString() + ' Kz');
            
            // Show dashboard content
            loadingScreen.style.display = 'none';
            dashboardContent.style.display = 'block';
        }
        
        // Animate value changes
        function animateValueChange(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element.textContent !== newValue) {
                element.classList.add('updated');
                element.textContent = newValue;
                setTimeout(() => {
                    element.classList.remove('updated');
                }, 500);
            } else {
                element.textContent = newValue;
            }
        }
        
        // Initialize chart - FIXED VERSION
        function initChart() {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            
            // Clear any existing chart
            if (earningsChart) {
                earningsChart.destroy();
            }
            
            // Calculate daily earnings
            const dailyEarnings = calculateDailyEarnings();
            const dailyValue = dailyEarnings.total;
            
            // Generate 7 days of data based on actual daily earnings
            const labels = [];
            const data = [];
            
            // Get last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
                labels.push(dayName.charAt(0).toUpperCase() + dayName.slice(1, 3));
                
                // Add earnings for each day (slight random variation for realism)
                const variation = 0.8 + Math.random() * 0.4; // 80% to 120% variation
                data.push(Math.round(dailyValue * variation));
            }
            
            // Create chart with FIXED configuration
            earningsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rendimentos Di√°rios (Kz)',
                        data: data,
                        borderColor: '#00c9ff',
                        backgroundColor: 'rgba(0, 201, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#92fe9d',
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBorderColor: '#0f2027',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Rendimento: ${context.parsed.y.toLocaleString()} Kz`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                display: true
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 11
                                },
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                display: true
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    if (value === 0) return '0';
                                    if (value < 1000) return value.toLocaleString();
                                    return (value/1000).toFixed(0) + 'K';
                                },
                                maxTicksLimit: 6
                            },
                            suggestedMax: dailyValue > 0 ? dailyValue * 1.5 : 100
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            cubicInterpolationMode: 'monotone'
                        }
                    }
                }
            });
            
            // Add resize observer to prevent chart from expanding
            const chartContainer = document.querySelector('.chart-container');
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (earningsChart) {
                        earningsChart.resize();
                    }
                }
            });
            
            resizeObserver.observe(chartContainer);
        }
        
        // Update chart with new data - EM TEMPO REAL
        function updateChart() {
            if (!earningsChart) return;
            
            const dailyEarnings = calculateDailyEarnings();
            const dailyValue = dailyEarnings.total;
            
            // Update the data
            const newData = earningsChart.data.datasets[0].data;
            
            // Shift data and add new value
            newData.shift();
            const variation = 0.8 + Math.random() * 0.4;
            newData.push(Math.round(dailyValue * variation));
            
            // Update chart
            earningsChart.update('none');
        }
        
        // Show modal for different pages
        async function showPageModal(page) {
            let title = '';
            let content = '';
            
            switch(page) {
                case 'balance':
                    title = 'Ver Saldos';
                    content = await getBalanceContent();
                    break;
                    
                case 'card':
                    title = 'Cart√£o Banc√°rio';
                    content = await getCardContent();
                    break;
                    
                case 'profile':
                    title = 'Os Meus Dados';
                    content = await getProfileContent();
                    break;
                    
                case 'earnings':
                    title = 'Rendimentos';
                    content = await getEarningsContent();
                    break;
                    
                case 'withdraw':
                    title = 'Levantamento';
                    content = await getWithdrawContent();
                    break;
                    
                case 'team':
                    title = 'Minha Equipe';
                    content = await getTeamContent();
                    break;
                    
                case 'graph':
                    title = 'Gr√°fico em Tempo Real';
                    content = await getGraphContent();
                    break;
                    
                case 'goals':
                    title = 'Minhas Metas';
                    content = await getGoalsContent();
                    break;
                    
                case 'lottery':
                    title = 'Lotaria';
                    content = await getLotteryContent();
                    break;
                    
                case 'support':
                    title = 'Suporte';
                    content = getSupportContent();
                    break;
                    
                case 'history':
                    title = 'Hist√≥rico';
                    content = await getHistoryContent();
                    break;
                    
                default:
                    title = page.charAt(0).toUpperCase() + page.slice(1);
                    content = `<p style="text-align: center; padding: 40px 0;">Funcionalidade "${title}" em desenvolvimento.</p>`;
            }
            
            createModal(title, content);
        }
        
        // Show tasks modal
        async function showTasksModal() {
            const title = 'Tarefas Di√°rias';
            const content = await getTasksContent();
            createModal(title, content);
        }
        
        // Create modal
        function createModal(title, content, customClass = '') {
            // Remove existing modal
            const existingModal = modalContainer.querySelector('.modal');
            if (existingModal) {
                modalContainer.removeChild(existingModal);
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = `modal ${customClass}`;
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    ${content}
                </div>
            `;
            
            modalContainer.appendChild(modal);
            
            // Close modal handler
            const closeBtn = modal.querySelector('.close-modal');
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Initialize scripts after modal is created
            setTimeout(() => {
                initializeModalScripts(modal);
            }, 100);
            
            return modal;
        }
        
        // Initialize modal scripts
        function initializeModalScripts(modal) {
            // Salvar dados banc√°rios
            const saveBankBtn = modal.querySelector('#saveBankDetails');
            if (saveBankBtn) {
                saveBankBtn.addEventListener('click', async function() {
                    const holderName = modal.querySelector('#holderName').value;
                    const bankName = modal.querySelector('#bankName').value;
                    const accountNumber = modal.querySelector('#accountNumber').value;
                    
                    if (!holderName || !bankName || !accountNumber) {
                        showModalMessage(modal, 'Por favor, preencha todos os campos.', 'error');
                        return;
                    }
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                    this.disabled = true;
                    
                    try {
                        await db.collection('users').doc(currentUser.uid).update({
                            bankDetails: {
                                holderName: holderName,
                                bankName: bankName,
                                accountNumber: accountNumber,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        });
                        
                        showModalMessage(modal, 'Dados banc√°rios salvos com sucesso!', 'success');
                        
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 2000);
                        
                        // Update user data
                        userData.bankDetails = {
                            holderName: holderName,
                            bankName: bankName,
                            accountNumber: accountNumber,
                            updatedAt: new Date()
                        };
                    } catch (error) {
                        console.error('Error saving bank details:', error);
                        showModalMessage(modal, 'Erro ao salvar dados banc√°rios. Tente novamente.', 'error');
                        this.innerHTML = '<i class="fas fa-save"></i> Salvar Dados Banc√°rios';
                        this.disabled = false;
                    }
                });
            }
            
            // Salvar metas
            const saveGoalBtn = modal.querySelector('#saveGoal');
            if (saveGoalBtn) {
                saveGoalBtn.addEventListener('click', async function() {
                    const goalName = modal.querySelector('#goalName').value;
                    const goalTarget = parseFloat(modal.querySelector('#goalTarget').value);
                    
                    if (!goalName || !goalTarget || goalTarget < 1000) {
                        showModalMessage(modal, 'Por favor, preencha todos os campos corretamente. O valor m√≠nimo √© 1000 Kz.', 'error');
                        return;
                    }
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                    this.disabled = true;
                    
                    try {
                        await db.collection('users').doc(currentUser.uid).collection('goals').add({
                            name: goalName,
                            target: goalTarget,
                            current: userData.earnings || 0,
                            progress: Math.min(100, (((userData.earnings || 0) / goalTarget) * 100)),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        modal.querySelector('#goalName').value = '';
                        modal.querySelector('#goalTarget').value = '';
                        
                        showModalMessage(modal, 'Meta adicionada com sucesso!', 'success');
                        
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 2000);
                    } catch (error) {
                        console.error('Error saving goal:', error);
                        showModalMessage(modal, 'Erro ao salvar meta. Tente novamente.', 'error');
                        this.innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Meta';
                        this.disabled = false;
                    }
                });
            }
            
            // Lotaria - Jogar
            const playLotteryBtn = modal.querySelector('#playLottery');
            if (playLotteryBtn) {
                playLotteryBtn.addEventListener('click', async function() {
                    const nums = [
                        parseInt(modal.querySelector('#num1').value),
                        parseInt(modal.querySelector('#num2').value),
                        parseInt(modal.querySelector('#num3').value),
                        parseInt(modal.querySelector('#num4').value),
                        parseInt(modal.querySelector('#num5').value)
                    ];
                    
                    // Get bet amount from input field
                    const betAmountInput = modal.querySelector('#betAmount');
                    const betAmount = betAmountInput ? parseInt(betAmountInput.value) : 1000;
                    const minBet = 1000;
                    
                    // Validar n√∫meros
                    const invalidNum = nums.find(n => n < 1 || n > 50 || isNaN(n));
                    const hasDuplicates = new Set(nums).size !== nums.length;
                    
                    if (invalidNum) {
                        showModalMessage(modal, 'Por favor, insira n√∫meros v√°lidos entre 1 e 50.', 'error');
                        return;
                    }
                    
                    if (hasDuplicates) {
                        showModalMessage(modal, 'N√£o pode haver n√∫meros repetidos.', 'error');
                        return;
                    }
                    
                    // Validar valor da aposta
                    if (isNaN(betAmount) || betAmount < minBet) {
                        showModalMessage(modal, `Valor da aposta inv√°lido. O valor m√≠nimo √© ${minBet.toLocaleString()} Kz.`, 'error');
                        return;
                    }
                    
                    if ((userData.balance || 0) < betAmount) {
                        showModalMessage(modal, `Saldo insuficiente. √â necess√°rio ${betAmount.toLocaleString()} Kz para jogar.`, 'error');
                        return;
                    }
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Jogando...';
                    this.disabled = true;
                    
                    try {
                        // Registrar aposta na lotaria
                        const lotteryDoc = await db.collection('users').doc(currentUser.uid).collection('lottery').add({
                            numbers: nums,
                            amount: betAmount,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            prize: 0,
                            hits: 0,
                            drawnNumbers: [],
                            userName: userData.fullName,
                            userId: userData.userId
                        });
                        
                        // Criar transa√ß√£o pendente
                        await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                            type: 'lottery',
                            amount: -betAmount,
                            description: `Aposta na lotaria (${nums.join(', ')}) - Valor: ${betAmount.toLocaleString()} Kz`,
                            status: 'completed',
                            balanceAfter: (userData.balance || 0) - betAmount,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lotteryId: lotteryDoc.id
                        });
                        
                        // Atualizar saldo do usu√°rio
                        await db.collection('users').doc(currentUser.uid).update({
                            balance: firebase.firestore.FieldValue.increment(-betAmount)
                        });
                        
                        // Atualizar dados locais do usu√°rio
                        userData.balance = (userData.balance || 0) - betAmount;
                        
                        showModalMessage(modal, 'Aposta registrada com sucesso! O sorteio √© autom√°tico e os resultados aparecer√£o aqui quando dispon√≠veis.', 'success');
                        
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 3000);
                        
                        // Atualizar dashboard
                        updateDashboard();
                        
                    } catch (error) {
                        console.error('Error playing lottery:', error);
                        showModalMessage(modal, 'Erro ao processar aposta. Tente novamente.', 'error');
                        this.innerHTML = '<i class="fas fa-ticket-alt"></i> Jogar na Lotaria';
                        this.disabled = false;
                    }
                });
            }
            
            // Tarefas
            const taskButtons = modal.querySelectorAll('.task-button');
            taskButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const taskNumber = this.getAttribute('data-task');
                    const today = new Date().toDateString();
                    const dailyEarnings = calculateDailyEarnings();
                    const taskReward = Math.round(dailyEarnings.task1);
                    
                    this.style.animation = 'spin 1s linear infinite';
                    this.style.pointerEvents = 'none';
                    
                    setTimeout(async () => {
                        try {
                            await db.collection('users').doc(currentUser.uid).update({
                                'balance': firebase.firestore.FieldValue.increment(taskReward),
                                'earnings': firebase.firestore.FieldValue.increment(taskReward),
                                'dailyTasks.completed': firebase.firestore.FieldValue.increment(1),
                                'dailyTasks.lastDate': today,
                                'dailyTasks.todayCompleted': firebase.firestore.FieldValue.increment(1)
                            });
                            
                            await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                                type: 'task_earning',
                                amount: taskReward,
                                description: 'Tarefa di√°ria ' + taskNumber,
                                status: 'completed',
                                balanceAfter: (userData.balance || 0) + taskReward,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Atualizar dados locais do usu√°rio
                            userData.balance = (userData.balance || 0) + taskReward;
                            userData.earnings = (userData.earnings || 0) + taskReward;
                            
                            modal.querySelector('#tasksStep2').style.display = 'none';
                            modal.querySelector('#tasksStep3').style.display = 'block';
                            
                            // Atualizar dashboard
                            updateDashboard();
                        } catch (error) {
                            console.error('Error completing task:', error);
                            showModalMessage(modal, 'Erro ao completar tarefa. Tente novamente.', 'error');
                            this.style.animation = '';
                            this.style.pointerEvents = 'auto';
                        }
                    }, 3000);
                });
            });
            
            // Navega√ß√£o de tarefas
            const nextToTasks = modal.querySelector('#nextToTasks');
            if (nextToTasks) {
                nextToTasks.addEventListener('click', function() {
                    modal.querySelector('#tasksStep1').style.display = 'none';
                    modal.querySelector('#tasksStep2').style.display = 'block';
                });
            }
            
            const backToTasksRules = modal.querySelector('#backToTasksRules');
            if (backToTasksRules) {
                backToTasksRules.addEventListener('click', function() {
                    modal.querySelector('#tasksStep2').style.display = 'none';
                    modal.querySelector('#tasksStep1').style.display = 'block';
                });
            }
            
            const continueTasks = modal.querySelector('#continueTasks');
            if (continueTasks) {
                continueTasks.addEventListener('click', function() {
                    modal.querySelector('#tasksStep3').style.display = 'none';
                    modal.querySelector('#tasksStep2').style.display = 'block';
                });
            }
            
            // Levantamento
            const withdrawAmountInput = modal.querySelector('#withdrawAmount');
            if (withdrawAmountInput) {
                const calculateWithdraw = () => {
                    const amount = parseFloat(withdrawAmountInput.value) || 0;
                    const fee = amount * 0.15;
                    const net = amount - fee;
                    
                    const feeEl = modal.querySelector('#withdrawFee');
                    const netEl = modal.querySelector('#withdrawNet');
                    const confirmAmountEl = modal.querySelector('#confirmAmount');
                    const confirmFeeEl = modal.querySelector('#confirmFee');
                    const confirmNetEl = modal.querySelector('#confirmNet');
                    
                    if (feeEl) feeEl.textContent = Math.round(fee).toLocaleString() + ' Kz';
                    if (netEl) netEl.textContent = Math.round(net).toLocaleString() + ' Kz';
                    if (confirmAmountEl) confirmAmountEl.textContent = Math.round(amount).toLocaleString() + ' Kz';
                    if (confirmFeeEl) confirmFeeEl.textContent = Math.round(fee).toLocaleString() + ' Kz';
                    if (confirmNetEl) confirmNetEl.textContent = Math.round(net).toLocaleString() + ' Kz';
                };
                
                withdrawAmountInput.addEventListener('input', calculateWithdraw);
                calculateWithdraw();
            }
            
            // Navega√ß√£o de levantamento
            const nextToStep2 = modal.querySelector('#nextToStep2');
            if (nextToStep2) {
                nextToStep2.addEventListener('click', function() {
                    const amount = parseFloat(modal.querySelector('#withdrawAmount').value) || 0;
                    const minWithdraw = 1000;
                    const availableBalance = userData.balance || 0;
                    
                    // Remove existing error messages
                    const existingMessages = modal.querySelectorAll('.modal-message');
                    existingMessages.forEach(msg => msg.remove());
                    
                    let hasError = false;
                    
                    if (amount < minWithdraw) {
                        showModalMessage(modal, `O valor m√≠nimo para levantamento √© ${minWithdraw.toLocaleString()} Kz.`, 'error');
                        hasError = true;
                    }
                    
                    if (amount > availableBalance) {
                        showModalMessage(modal, `Saldo insuficiente. Seu saldo dispon√≠vel √© ${availableBalance.toLocaleString()} Kz.`, 'error');
                        hasError = true;
                    }
                    
                    if (hasError) return;
                    
                    modal.querySelector('#withdrawStep1').style.display = 'none';
                    modal.querySelector('#withdrawStep2').style.display = 'block';
                });
            }
            
            const backToStep1 = modal.querySelector('#backToStep1');
            if (backToStep1) {
                backToStep1.addEventListener('click', function() {
                    modal.querySelector('#withdrawStep2').style.display = 'none';
                    modal.querySelector('#withdrawStep1').style.display = 'block';
                });
            }
            
            const nextToStep3 = modal.querySelector('#nextToStep3');
            if (nextToStep3) {
                nextToStep3.addEventListener('click', function() {
                    modal.querySelector('#withdrawStep2').style.display = 'none';
                    modal.querySelector('#withdrawStep3').style.display = 'block';
                });
            }
            
            const backToStep2 = modal.querySelector('#backToStep2');
            if (backToStep2) {
                backToStep2.addEventListener('click', function() {
                    modal.querySelector('#withdrawStep3').style.display = 'none';
                    modal.querySelector('#withdrawStep2').style.display = 'block';
                });
            }
            
            const confirmWithdraw = modal.querySelector('#confirmWithdraw');
            if (confirmWithdraw) {
                confirmWithdraw.addEventListener('click', async function() {
                    const amount = parseFloat(modal.querySelector('#withdrawAmount').value) || 0;
                    const fee = amount * 0.15;
                    const net = amount - fee;
                    const availableBalance = userData.balance || 0;
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                    this.disabled = true;
                    
                    try {
                        await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                            type: 'withdrawal',
                            amount: amount,
                            fee: fee,
                            netAmount: net,
                            description: 'Levantamento para conta banc√°ria',
                            status: 'pending',
                            bankDetails: userData.bankDetails || {},
                            balanceAfter: availableBalance - amount,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        await db.collection('users').doc(currentUser.uid).update({
                            balance: firebase.firestore.FieldValue.increment(-amount)
                        });
                        
                        // Atualizar dados locais do usu√°rio
                        userData.balance = availableBalance - amount;
                        
                        modal.querySelector('#withdrawStep3').style.display = 'none';
                        modal.querySelector('#withdrawStep4').style.display = 'block';
                        
                        // Atualizar dashboard
                        updateDashboard();
                    } catch (error) {
                        console.error('Error processing withdrawal:', error);
                        showModalMessage(modal, 'Erro ao processar levantamento. Tente novamente.', 'error');
                        this.innerHTML = '<i class="fas fa-paper-plane"></i> Confirmar Levantamento';
                        this.disabled = false;
                    }
                });
            }
            
            // Copiar link de convite
            const copyInviteLink = modal.querySelector('#copyInviteLink');
            if (copyInviteLink) {
                copyInviteLink.addEventListener('click', function() {
                    const link = `https://elite-smart.onrender.com/signup.html?ref=${userData.userId}`;
                    navigator.clipboard.writeText(link).then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i> Link Copiado!';
                        this.style.background = '#92fe9d';
                        
                        setTimeout(() => {
                            this.innerHTML = originalText;
                            this.style.background = 'linear-gradient(90deg, #00c9ff, #92fe9d)';
                        }, 2000);
                    });
                });
            }
        }
        
        // Get balance content
        async function getBalanceContent() {
            return `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 10px;">Dispon√≠vel</div>
                        <div style="font-size: 2.5rem; font-weight: bold; color: #92fe9d;">${(userData.balance || 0).toLocaleString()} Kz</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 5px;">B√≥nus + Rendimentos</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Retirado</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #00c9ff;">${(userData.withdrawn || 0).toLocaleString()} Kz</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Ganhos</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #00c9ff;">${(userData.earnings || 0).toLocaleString()} Kz</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Bloqueado</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #ffd700;">${(userData.blocked || 0).toLocaleString()} Kz</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 5px;">Em investimentos ativos</div>
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get tasks content
        async function getTasksContent() {
            const today = new Date().toDateString();
            const hasActiveInvestment = userData.activeInvestments && userData.activeInvestments.length > 0;
            const dailyTasks = userData.dailyTasks || { completed: 0, lastDate: null, todayCompleted: 0 };
            const canDoTasks = hasActiveInvestment && dailyTasks.lastDate !== today;
            const tasksCompletedToday = dailyTasks.lastDate === today ? dailyTasks.todayCompleted : 0;
            
            const dailyEarnings = calculateDailyEarnings();
            const taskReward = Math.round(dailyEarnings.task1);
            
            return `
                <div style="padding: 20px 0;">
                    <div id="tasksSteps">
                        <!-- Step 1: Rules -->
                        <div id="tasksStep1">
                            <h4 style="color: #00c9ff; margin-bottom: 20px;">Tarefas Di√°rias</h4>
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <div style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                    <i class="fas ${hasActiveInvestment ? 'fa-check-circle' : 'fa-times-circle'}" style="color: ${hasActiveInvestment ? '#92fe9d' : '#ff6b6b'}; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">${hasActiveInvestment ? 'Tarefas Liberadas' : 'Tarefas Bloqueadas'}</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                            ${hasActiveInvestment ? 'Complete 2 tarefas di√°rias para ganhar b√¥nus' : 'Necess√°rio ter um investimento ativo'}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: ${dailyTasks.lastDate !== today ? '#92fe9d' : '#ff6b6b'}; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">Limite Di√°rio</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Apenas 2 tarefas podem ser conclu√≠das por dia</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: #92fe9d; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">Recompensa por Tarefa</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${taskReward.toLocaleString()} Kz por tarefa conclu√≠da</div>
                                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 3px;">(50% do seu rendimento di√°rio)</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${!hasActiveInvestment ? `
                                <div class="modal-message warning">
                                    <p>
                                        <i class="fas fa-exclamation-triangle"></i> Voc√™ precisa ter um investimento ativo para realizar tarefas.
                                    </p>
                                </div>
                            ` : ''}
                            
                            ${dailyTasks.lastDate === today && tasksCompletedToday >= 2 ? `
                                <div class="modal-message warning">
                                    <p>
                                        <i class="fas fa-info-circle"></i> Voc√™ j√° completou todas as tarefas de hoje. Volte amanh√£!
                                    </p>
                                </div>
                            ` : ''}
                            
                            <button class="modal-btn" id="nextToTasks" ${!canDoTasks || tasksCompletedToday >= 2 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                <i class="fas fa-play"></i> Iniciar Tarefas
                            </button>
                        </div>
                        
                        <!-- Step 2: Tasks -->
                        <div id="tasksStep2" style="display: none; text-align: center;">
                            <h4 style="color: #00c9ff; margin-bottom: 20px;">Tarefas Di√°rias</h4>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">Clique em uma tarefa para complet√°-la e ganhar ${taskReward.toLocaleString()} Kz</p>
                            
                            <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 30px;">
                                <div class="task-button" data-task="1" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #00c9ff, #92fe9d); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #0f2027; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,201,255,0.3);">
                                    <i class="fas fa-check" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <span>Tarefa 1</span>
                                </div>
                                
                                <div class="task-button" data-task="2" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #00c9ff, #92fe9d); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #0f2027; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,201,255,0.3);">
                                    <i class="fas fa-check" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <span>Tarefa 2</span>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: rgba(255,255,255,0.7);">Tarefas conclu√≠das hoje:</span>
                                    <span id="tasksCompletedCount" style="color: #92fe9d; font-weight: bold;">${tasksCompletedToday}/2</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255,255,255,0.7);">Ganhos de hoje:</span>
                                    <span id="tasksEarnings" style="color: #00c9ff; font-weight: bold;">${(tasksCompletedToday * taskReward).toLocaleString()} Kz</span>
                                </div>
                            </div>
                            
                            <button class="modal-btn" style="background: rgba(255,255,255,0.1); color: white;" id="backToTasksRules">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                        
                        <!-- Step 3: Task Complete -->
                        <div id="tasksStep3" style="display: none; text-align: center;">
                            <div style="font-size: 5rem; color: #92fe9d; margin-bottom: 20px;">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h4 style="color: #00c9ff; margin-bottom: 15px;">Tarefa Conclu√≠da!</h4>
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">
                                Voc√™ completou uma tarefa com sucesso!
                            </p>
                            <div style="font-size: 2rem; color: #92fe9d; font-weight: bold; margin-bottom: 25px;">
                                +${taskReward.toLocaleString()} Kz
                            </div>
                            <p style="color: rgba(255,255,255,0.6); margin-bottom: 25px;">
                                O valor foi creditado na sua conta dispon√≠vel.
                            </p>
                            <button class="modal-btn" id="continueTasks">
                                <i class="fas fa-arrow-right"></i> Continuar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Get card content
        async function getCardContent() {
            const hasBankDetails = userData.bankDetails && userData.bankDetails.accountNumber;
            
            return `
                <div style="padding: 20px 0;">
                    ${hasBankDetails ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: #00c9ff; margin-bottom: 20px;">Dados Banc√°rios Cadastrados</h4>
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Nome do Titular</div>
                                <div style="font-size: 1.1rem; font-weight: 500;">${userData.bankDetails.holderName || ''}</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Nome do Banco</div>
                                <div style="font-size: 1.1rem; font-weight: 500;">${userData.bankDetails.bankName || ''}</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">N√∫mero da Conta/Cart√£o</div>
                                <div style="font-size: 1.1rem; font-weight: 500; font-family: monospace;">${userData.bankDetails.accountNumber || ''}</div>
                            </div>
                        </div>
                        
                        <div class="modal-message warning">
                            <p>
                                <i class="fas fa-exclamation-triangle"></i> Para corre√ß√µes, contate o suporte.
                            </p>
                        </div>
                    ` : `
                        <div id="bankForm">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">Nome do Titular</label>
                                <input type="text" id="holderName" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">Nome do Banco</label>
                                <input type="text" id="bankName" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            </div>
                            
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">N√∫mero da Conta/Cart√£o</label>
                                <input type="text" id="accountNumber" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            </div>
                            
                            <div class="modal-message warning">
                                <p>
                                    <i class="fas fa-exclamation-triangle"></i> Para corre√ß√µes, contate o suporte.
                                </p>
                            </div>
                            
                            <button class="modal-btn" id="saveBankDetails">
                                <i class="fas fa-save"></i> Salvar Dados Banc√°rios
                            </button>
                        </div>
                    `}
                    
                    <button class="modal-btn" style="background: rgba(255,255,255,0.1); color: white; margin-top: 15px;" onclick="this.closest('.modal').style.display='none'">
                        Fechar
                    </button>
                </div>
            `;
        }
        
        // Get profile content
        async function getProfileContent() {
            const createdAt = userData.createdAt?.toDate ? userData.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data n√£o dispon√≠vel';
            
            return `
                <div style="padding: 20px 0;">
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Nome Completo</div>
                            <div style="font-size: 1.1rem; font-weight: 500;">${userData.fullName}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">E-mail</div>
                            <div style="font-size: 1.1rem; font-weight: 500;">${userData.email}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Telefone</div>
                            <div style="font-size: 1.1rem; font-weight: 500;">${userData.phone}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">ID do Usu√°rio</div>
                            <div style="font-size: 1.1rem; font-weight: 500; font-family: monospace;">${userData.userId}</div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Data de Cria√ß√£o</div>
                            <div style="font-size: 1.1rem; font-weight: 500;">${createdAt}</div>
                        </div>
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get earnings content
        async function getEarningsContent() {
            // Buscar transa√ß√µes de rendimentos do usu√°rio
            const earningsSnapshot = await db.collection('users').doc(currentUser.uid)
                .collection('transactions')
                .where('type', 'in', ['investment_earning', 'task_earning', 'lottery_win', 'referral_commission', 'bonus'])
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();
            
            let earningsHtml = '';
            if (!earningsSnapshot.empty) {
                earningsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate ? 
                        data.createdAt.toDate().toLocaleDateString('pt-BR') + ' ' + 
                        data.createdAt.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '-';
                    
                    let typeText = '';
                    switch(data.type) {
                        case 'investment_earning': typeText = 'Rendimento de Investimento'; break;
                        case 'task_earning': typeText = 'Tarefa Di√°ria'; break;
                        case 'lottery_win': typeText = 'Pr√™mio da Lotaria'; break;
                        case 'referral_commission': typeText = 'Comiss√£o de Indica√ß√£o'; break;
                        case 'bonus': typeText = 'B√≥nus'; break;
                        default: typeText = 'Rendimento';
                    }
                    
                    earningsHtml += `
                        <tr>
                            <td>${date}</td>
                            <td>${typeText}: ${data.description || ''}</td>
                            <td style="color: #92fe9d; font-weight: bold;">+${data.amount.toLocaleString()} Kz</td>
                        </tr>
                    `;
                });
            } else {
                earningsHtml = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Nenhum rendimento registrado ainda.</td></tr>';
            }
            
            const dailyEarnings = calculateDailyEarnings();
            const totalEarnings = userData.earnings || 0;
            const referralEarnings = userData.referralEarnings || 0;
            
            return `
                <div style="padding: 20px 0;">
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Rendimento Di√°rio</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #92fe9d;">${Math.round(dailyEarnings.total).toLocaleString()} Kz</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Total Ganho</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #00c9ff;">${totalEarnings.toLocaleString()} Kz</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">De Investimentos</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #92fe9d;">${Math.round(dailyEarnings.fromInvestment).toLocaleString()} Kz/dia</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">De Indica√ß√µes</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #00c9ff;">${referralEarnings.toLocaleString()} Kz</div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="color: #00c9ff; margin-bottom: 15px;">Hist√≥rico de Rendimentos</h4>
                    <div style="overflow-x: auto; max-height: 300px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);">Data/Hora</th>
                                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);">Descri√ß√£o</th>
                                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${earningsHtml}
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'" style="margin-top: 25px;">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get withdraw content
        async function getWithdrawContent() {
            const hasActiveInvestment = userData.activeInvestments && userData.activeInvestments.length > 0;
            const hasBankDetails = userData.bankDetails && userData.bankDetails.accountNumber;
            const availableBalance = userData.balance || 0;
            const minWithdraw = 1000;
            
            return `
                <div style="padding: 20px 0;">
                    <div id="withdrawSteps">
                        <!-- Step 1: Rules -->
                        <div id="withdrawStep1">
                            <h4 style="color: #00c9ff; margin-bottom: 20px;">Regras de Levantamento</h4>
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <div style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: #92fe9d; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">Disponibilidade</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Dispon√≠vel todos os dias, apenas com investimento ativo</div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: #92fe9d; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">Taxa de Levantamento</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">15% de taxa aplicada sobre o valor solicitado</div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: #92fe9d; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">Prazo de Processamento</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">2-24h (dias √∫teis) ou 72h (fins de semana)</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: flex-start;">
                                    <i class="fas fa-check-circle" style="color: #92fe9d; margin-right: 10px; margin-top: 3px;"></i>
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">Valor M√≠nimo</div>
                                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${minWithdraw.toLocaleString()} Kz</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${!hasActiveInvestment ? `
                                <div class="modal-message error">
                                    <p>
                                        <i class="fas fa-exclamation-triangle"></i> Voc√™ precisa ter um investimento ativo para realizar levantamentos.
                                    </p>
                                </div>
                            ` : ''}
                            
                            ${!hasBankDetails ? `
                                <div class="modal-message error">
                                    <p>
                                        <i class="fas fa-exclamation-triangle"></i> Voc√™ precisa cadastrar seus dados banc√°rios antes de realizar um levantamento.
                                    </p>
                                </div>
                            ` : ''}
                            
                            <button class="modal-btn" id="nextToStep2" ${!hasActiveInvestment || !hasBankDetails ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                <i class="fas fa-arrow-right"></i> Continuar
                            </button>
                        </div>
                        
                        <!-- Step 2: Amount -->
                        <div id="withdrawStep2" style="display: none;">
                            <h4 style="color: #00c9ff; margin-bottom: 20px;">Valor do Levantamento</h4>
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">Saldo Dispon√≠vel</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #92fe9d;">${availableBalance.toLocaleString()} Kz</div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">Valor do Levantamento (Kz)</div>
                                    <input type="number" id="withdrawAmount" min="${minWithdraw}" max="${availableBalance}" value="${Math.min(availableBalance, 5000)}" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 1.2rem; text-align: center;">
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 8px;">M√≠nimo: ${minWithdraw.toLocaleString()} Kz</div>
                                </div>
                                
                                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span style="color: rgba(255,255,255,0.7);">Taxa (15%):</span>
                                        <span id="withdrawFee" style="color: #ff6b6b; font-weight: bold;">0 Kz</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.7);">Valor a Receber:</span>
                                        <span id="withdrawNet" style="color: #92fe9d; font-weight: bold;">0 Kz</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="modal-btn" style="background: rgba(255,255,255,0.1); color: white; flex: 1;" id="backToStep1">
                                    <i class="fas fa-arrow-left"></i> Voltar
                                </button>
                                <button class="modal-btn" id="nextToStep3" style="flex: 2;">
                                    <i class="fas fa-check"></i> Confirmar Valor
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Confirmation -->
                        <div id="withdrawStep3" style="display: none;">
                            <h4 style="color: #00c9ff; margin-bottom: 20px;">Confirmar Levantamento</h4>
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <i class="fas fa-university" style="font-size: 3rem; color: #00c9ff; margin-bottom: 15px;"></i>
                                    <div style="font-weight: 500;">${userData.bankDetails?.bankName || 'Banco'}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${userData.bankDetails?.accountNumber || ''}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-top: 5px;">${userData.bankDetails?.holderName || ''}</div>
                                </div>
                                
                                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                        <span style="color: rgba(255,255,255,0.7);">Valor Solicitado:</span>
                                        <span id="confirmAmount" style="font-weight: bold;">0 Kz</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                        <span style="color: rgba(255,255,255,0.7);">Taxa (15%):</span>
                                        <span id="confirmFee" style="color: #ff6b6b; font-weight: bold;">0 Kz</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <span style="color: rgba(255,255,255,0.7);">Valor a Receber:</span>
                                        <span id="confirmNet" style="color: #92fe9d; font-weight: bold;">0 Kz</span>
                                    </div>
                                    
                                    <div class="modal-message warning">
                                        <p>
                                            <i class="fas fa-clock"></i> Este levantamento ser√° processado em 2-24 horas (dias √∫teis).
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="modal-btn" style="background: rgba(255,255,255,0.1); color: white; flex: 1;" id="backToStep2">
                                    <i class="fas fa-arrow-left"></i> Voltar
                                </button>
                                <button class="modal-btn" id="confirmWithdraw" style="flex: 2;">
                                    <i class="fas fa-paper-plane"></i> Confirmar Levantamento
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Success -->
                        <div id="withdrawStep4" style="display: none; text-align: center; padding: 20px 0;">
                            <div style="font-size: 5rem; color: #92fe9d; margin-bottom: 20px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h4 style="color: #00c9ff; margin-bottom: 15px;">Levantamento Solicitado!</h4>
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 25px;">
                                Sua solicita√ß√£o de levantamento foi enviada com sucesso e ser√° processada em at√© 24 horas √∫teis.
                            </p>
                            <button class="modal-btn" onclick="this.closest('.modal').style.display='none'">
                                <i class="fas fa-check"></i> Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Get team content
        async function getTeamContent() {
            const teamSnapshot = await db.collection('users').doc(currentUser.uid)
                .collection('team')
                .orderBy('joinedAt', 'desc')
                .get();
            
            let teamHtml = '';
            if (!teamSnapshot.empty) {
                teamSnapshot.forEach(doc => {
                    const member = doc.data();
                    const date = member.joinedAt?.toDate ? member.joinedAt.toDate().toLocaleDateString('pt-BR') : '-';
                    teamHtml += `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 500;">${member.name}</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">ID: ${member.userId} ‚Ä¢ ${date}</div>
                            </div>
                            <span style="color: ${member.status === 'active' ? '#92fe9d' : '#ffd700'}; font-weight: bold; font-size: 0.9rem;">
                                ${member.status === 'active' ? 'Ativo' : 'Pendente'}
                            </span>
                        </div>
                    `;
                });
            } else {
                teamHtml = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.6);">Nenhum membro na sua equipe ainda.</div>';
            }
            
            return `
                <div style="padding: 20px 0;">
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <p style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">Convide amigos e ganhe 15% de comiss√£o sobre o primeiro investimento deles.</p>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">Seu link de convite:</div>
                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-family: monospace; word-break: break-all; font-size: 0.9rem;">
                                https://elite-smart.onrender.com/signup.html?ref=${userData.userId}
                            </div>
                        </div>
                        
                        <button id="copyInviteLink" style="width: 100%; padding: 12px; background: linear-gradient(90deg, #00c9ff, #92fe9d); border: none; border-radius: 8px; color: #0f2027; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fas fa-copy"></i> Copiar Link de Convite
                        </button>
                    </div>
                    
                    <h4 style="color: #00c9ff; margin-bottom: 15px;">Membros da Equipe (${teamSnapshot.size})</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${teamHtml}
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'" style="margin-top: 25px;">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get graph content
        async function getGraphContent() {
            const dailyEarnings = calculateDailyEarnings();
            
            return `
                <div style="padding: 20px 0;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h4 style="color: #00c9ff; margin-bottom: 10px;">Gr√°fico de Rendimentos em Tempo Real</h4>
                        <p style="color: rgba(255,255,255,0.7);">Acompanhe o crescimento dos seus investimentos</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 25px; height: 300px;">
                        <canvas id="detailedChart" height="250"></canvas>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px;">
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Hoje</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #92fe9d;">${Math.round(dailyEarnings.total).toLocaleString()} Kz</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Esta Semana</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #00c9ff;">${Math.round(dailyEarnings.total * 7).toLocaleString()} Kz</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Este M√™s</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #ffd700;">${Math.round(dailyEarnings.total * 30).toLocaleString()} Kz</div>
                        </div>
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get goals content
        async function getGoalsContent() {
            const goalsSnapshot = await db.collection('users').doc(currentUser.uid)
                .collection('goals')
                .orderBy('createdAt', 'desc')
                .get();
            
            let goalsHtml = '';
            if (!goalsSnapshot.empty) {
                goalsSnapshot.forEach(doc => {
                    const goal = doc.data();
                    const progress = Math.min(100, ((userData.earnings || 0) / goal.target) * 100);
                    
                    goalsHtml += `
                        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-weight: 500;">${goal.name}</div>
                                <div style="font-size: 0.9rem; color: #92fe9d; font-weight: bold;">${progress.toFixed(1)}%</div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.3); height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
                                <div style="background: linear-gradient(90deg, #00c9ff, #92fe9d); height: 100%; width: ${progress}%; transition: width 0.5s;"></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                <span>${(userData.earnings || 0).toLocaleString()} Kz</span>
                                <span>${goal.target.toLocaleString()} Kz</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                goalsHtml = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.6);">Nenhuma meta definida ainda.</div>';
            }
            
            return `
                <div style="padding: 20px 0;">
                    <div id="goalForm" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <h4 style="color: #00c9ff; margin-bottom: 20px;">Nova Meta</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">Nome da Meta</label>
                            <input type="text" id="goalName" placeholder="Ex: Carro, Casa, Viagem..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">Valor Alvo (Kz)</label>
                            <input type="number" id="goalTarget" min="1000" placeholder="Ex: 2000000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                        </div>
                        
                        <button class="modal-btn" id="saveGoal">
                            <i class="fas fa-plus-circle"></i> Adicionar Meta
                        </button>
                    </div>
                    
                    <h4 style="color: #00c9ff; margin-bottom: 15px;">Minhas Metas (${goalsSnapshot.size})</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${goalsHtml}
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'" style="margin-top: 25px;">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get lottery content
        async function getLotteryContent() {
            // Get lottery history
            const lotteryHistory = await db.collection('users').doc(currentUser.uid)
                .collection('lottery')
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get();
            
            let historyHtml = '';
            if (!lotteryHistory.empty) {
                lotteryHistory.forEach(doc => {
                    const lottery = doc.data();
                    const date = lottery.createdAt?.toDate ? lottery.createdAt.toDate().toLocaleDateString('pt-BR') : '-';
                    const status = lottery.status === 'completed' ? 'Conclu√≠do' : lottery.status === 'pending' ? 'Pendente' : 'Cancelado';
                    const prizeText = lottery.prize > 0 ? `Ganhou: ${lottery.prize.toLocaleString()} Kz` : lottery.status === 'completed' ? 'N√£o ganhou' : 'Aguardando sorteio';
                    const hitsText = lottery.status === 'completed' && lottery.hits > 0 ? `(${lottery.hits} acertos)` : '';
                    const drawnNumbersText = lottery.drawnNumbers ? `Sorteados: ${lottery.drawnNumbers.join(', ')}` : '';
                    
                    historyHtml += `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: 500;">${date}</div>
                                <span style="color: ${lottery.status === 'completed' ? (lottery.prize > 0 ? '#92fe9d' : '#ff6b6b') : lottery.status === 'pending' ? '#ffd700' : '#ff6b6b'}; font-size: 0.8rem;">
                                    ${status} ${hitsText}
                                </span>
                            </div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                Aposta: ${lottery.amount?.toLocaleString() || '0'} Kz<br>
                                Seus n√∫meros: ${lottery.numbers.join(', ')}
                                ${lottery.status === 'completed' ? `<br>${drawnNumbersText}` : ''}
                                ${lottery.prize > 0 ? `<br><span style="color: #92fe9d; font-weight: bold;">${prizeText}</span>` : 
                                  lottery.status === 'completed' ? `<span style="color: #ff6b6b;">${prizeText}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                historyHtml = '<div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">Nenhuma aposta registrada ainda.</div>';
            }
            
            return `
                <div style="padding: 20px 0; text-align: center;">
                    <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; margin-bottom: 25px;">
                        <i class="fas fa-dice" style="font-size: 4rem; color: #00c9ff; margin-bottom: 20px;"></i>
                        <h4 style="color: #00c9ff; margin-bottom: 10px;">Lotaria EliteSmart</h4>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 25px;">
                            Escolha 5 n√∫meros entre 1 e 50 e defina o valor da aposta. O sorteio √© autom√°tico e os pr√™mios s√£o pagos conforme os acertos!
                        </p>
                        
                        <div style="margin-bottom: 25px;">
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">Escolha 5 n√∫meros (1-50):</p>
                            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                                <input type="number" min="1" max="50" style="width: 60px; height: 60px; text-align: center; font-size: 1.2rem; background: rgba(255,255,255,0.1); border: 2px solid #00c9ff; border-radius: 10px; color: white;" id="num1">
                                <input type="number" min="1" max="50" style="width: 60px; height: 60px; text-align: center; font-size: 1.2rem; background: rgba(255,255,255,0.1); border: 2px solid #00c9ff; border-radius: 10px; color: white;" id="num2">
                                <input type="number" min="1" max="50" style="width: 60px; height: 60px; text-align: center; font-size: 1.2rem; background: rgba(255,255,255,0.1); border: 2px solid #00c9ff; border-radius: 10px; color: white;" id="num3">
                                <input type="number" min="1" max="50" style="width: 60px; height: 60px; text-align: center; font-size: 1.2rem; background: rgba(255,255,255,0.1); border: 2px solid #00c9ff; border-radius: 10px; color: white;" id="num4">
                                <input type="number" min="1" max="50" style="width: 60px; height: 60px; text-align: center; font-size: 1.2rem; background: rgba(255,255,255,0.1); border: 2px solid #00c9ff; border-radius: 10px; color: white;" id="num5">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <p style="color: rgba(255,255,255,0.8); margin-bottom: 8px;">Valor da Aposta (Kz):</p>
                                <input type="number" id="betAmount" min="1000" value="1000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid #92fe9d; border-radius: 8px; color: white; font-size: 1.2rem; text-align: center;">
                                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 5px;">Valor m√≠nimo: 1.000 Kz</p>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="color: var(--secondary); margin-bottom: 10px;">Regras de Premia√ß√£o (Multiplicadores)</h5>
                            <div style="text-align: left; font-size: 0.9rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>5 n√∫meros acertados</span>
                                    <span style="color: #92fe9d; font-weight: bold;">500x o valor apostado</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>4 n√∫meros acertados</span>
                                    <span style="color: #00c9ff; font-weight: bold;">50x o valor apostado</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>3 n√∫meros acertados</span>
                                    <span style="color: #ffd700; font-weight: bold;">10x o valor apostado</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>2 n√∫meros acertados</span>
                                    <span style="color: #92fe9d; font-weight: bold;">2.5x o valor apostado</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>1 n√∫mero acertado</span>
                                    <span style="font-weight: bold;">0.5x o valor apostado (50%)</span>
                                </div>
                            </div>
                        </div>
                        
                        <button class="modal-btn" id="playLottery">
                            <i class="fas fa-ticket-alt"></i> Jogar na Lotaria
                        </button>
                    </div>
                    
                    <h4 style="color: #00c9ff; margin-bottom: 15px;">Hist√≥rico de Apostas</h4>
                    <div style="max-height: 200px; overflow-y: auto; margin-bottom: 25px;">
                        ${historyHtml}
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get support content
        function getSupportContent() {
            return `
                <div style="padding: 20px 0; text-align: center;">
                    <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; margin-bottom: 25px;">
                        <i class="fas fa-headset" style="font-size: 4rem; color: #00c9ff; margin-bottom: 20px;"></i>
                        <h4 style="color: #00c9ff; margin-bottom: 10px;">Suporte EliteSmart</h4>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 25px;">
                            Nosso suporte est√° dispon√≠vel 24/7 para ajudar voc√™ com qualquer d√∫vida ou problema.
                        </p>
                        
                        <a href="https://wa.me/message/UOBYP5H5W5KGP1" target="_blank" style="text-decoration: none;">
                            <button class="modal-btn" style="background: #25D366;">
                                <i class="fab fa-whatsapp"></i> WhatsApp Suporte
                            </button>
                        </a>
                        
                        <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-bottom: 10px;">Outras formas de contato:</p>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    <i class="fas fa-envelope" style="color: #00c9ff;"></i>
                                    <span>suporte@elitesmart.com</span>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    <i class="fas fa-phone" style="color: #00c9ff;"></i>
                                    <span>(+244) 900 000 000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Get history content
        async function getHistoryContent() {
            const transactionsSnapshot = await db.collection('users').doc(currentUser.uid)
                .collection('transactions')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();
            
            let transactionsHtml = '';
            if (!transactionsSnapshot.empty) {
                transactionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate ? 
                        data.createdAt.toDate().toLocaleDateString('pt-BR') + ' ' + 
                        data.createdAt.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '-';
                    
                    let typeClass = '';
                    let typeIcon = '';
                    let amountPrefix = '';
                    
                    switch(data.type) {
                        case 'deposit':
                            typeClass = 'deposit';
                            typeIcon = 'fa-download';
                            amountPrefix = '+';
                            break;
                        case 'withdrawal':
                            typeClass = 'withdrawal';
                            typeIcon = 'fa-upload';
                            amountPrefix = '-';
                            break;
                        case 'investment':
                            typeClass = 'investment';
                            typeIcon = 'fa-seedling';
                            amountPrefix = '-';
                            break;
                        case 'investment_earning':
                            typeClass = 'earning';
                            typeIcon = 'fa-chart-line';
                            amountPrefix = '+';
                            break;
                        case 'task_earning':
                            typeClass = 'earning';
                            typeIcon = 'fa-tasks';
                            amountPrefix = '+';
                            break;
                        case 'bonus':
                            typeClass = 'bonus';
                            typeIcon = 'fa-gift';
                            amountPrefix = '+';
                            break;
                        case 'lottery':
                            typeClass = 'lottery';
                            typeIcon = 'fa-dice';
                            amountPrefix = '-';
                            break;
                        case 'lottery_win':
                            typeClass = 'lottery_win';
                            typeIcon = 'fa-trophy';
                            amountPrefix = '+';
                            break;
                        case 'referral_commission':
                            typeClass = 'commission';
                            typeIcon = 'fa-user-plus';
                            amountPrefix = '+';
                            break;
                        default:
                            typeClass = 'other';
                            typeIcon = 'fa-exchange-alt';
                    }
                    
                    transactionsHtml += `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="background: rgba(0,201,255,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${typeIcon}" style="color: #00c9ff;"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${data.description || 'Transa√ß√£o'}</div>
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">${date}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: ${amountPrefix === '+' ? '#92fe9d' : amountPrefix === '-' ? '#ff6b6b' : '#00c9ff'}">
                                    ${amountPrefix}${data.amount.toLocaleString()} Kz
                                </div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                                    ${data.status === 'completed' ? 'Conclu√≠do' : data.status === 'pending' ? 'Pendente' : 'Cancelado'}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                transactionsHtml = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.6);">Nenhuma transa√ß√£o registrada ainda.</div>';
            }
            
            return `
                <div style="padding: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="color: #00c9ff;">Hist√≥rico de Transa√ß√µes</h4>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${transactionsSnapshot.size} transa√ß√µes</div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${transactionsHtml}
                    </div>
                    
                    <button class="modal-btn" onclick="this.closest('.modal').style.display='none'" style="margin-top: 25px;">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            `;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (unsubscribeUser) {
                unsubscribeUser();
            }
            if (unsubscribeLottery) {
                unsubscribeLottery();
            }
        });
    </script>
</body>
</html>
